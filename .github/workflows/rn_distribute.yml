name: React Native Android Distribution

on:
  push:
    branches:
      - main
      - develop
jobs:
  build_android:
    name: Build APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm install

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Build Release APK
        run: ./gradlew clean assembleRelease --no-daemon
        working-directory: android

      - name: Verify APK exists
        run: |
          APK="android/app/build/outputs/apk/release/app-release.apk"
          if [ ! -f "$APK" ]; then
            echo "❌ APK not found at $APK"
            find android/app/build -name "*.apk" 2>/dev/null || echo "No APKs found anywhere"
            exit 1
          fi
          echo "✅ APK found: $(ls -lh $APK)"

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 7

  distribute_android:
    name: Distribute Android to Firebase
    runs-on: ubuntu-latest
    needs: build_android
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: app-release
          path: release

      - name: Verify APK downloaded
        run: |
          test -f release/app-release.apk
          echo "✅ APK ready: $(ls -lh release/app-release.apk)"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Distribute to Firebase App Distribution
        env:
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_TESTER_GROUPS: ${{ secrets.FIREBASE_TESTER_GROUPS }}
          FIREBASE_TESTERS: ${{ secrets.FIREBASE_TESTERS }}
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          APK_PATH="release/app-release.apk"

          # Resolve Firebase App ID — use secret or fall back to google-services.json
          FIREBASE_APP_ID_RESOLVED="${FIREBASE_APP_ID:-$(grep -o '\"mobilesdk_app_id\":[[:space:]]*\"[^\"]*\"' android/app/google-services.json | head -1 | cut -d'\"' -f4)}"
          if [ -z "$FIREBASE_APP_ID_RESOLVED" ]; then
            echo "❌ FIREBASE_APP_ID is empty and could not be read from android/app/google-services.json"
            exit 1
          fi
          echo "✅ Using Firebase App ID: $FIREBASE_APP_ID_RESOLVED"

          # Require at least one distribution target
          if [ -z "$FIREBASE_TESTER_GROUPS" ] && [ -z "$FIREBASE_TESTERS" ]; then
            echo "❌ Set FIREBASE_TESTER_GROUPS or FIREBASE_TESTERS in GitHub repository secrets."
            exit 1
          fi

          # Require Firebase token
          if [ -z "$FIREBASE_TOKEN" ]; then
            echo "❌ FIREBASE_TOKEN secret is not set. Run 'firebase login:ci' locally to generate one."
            exit 1
          fi

          # Build distribute command
          DIST_CMD=(firebase appdistribution:distribute "$APK_PATH"
            --app "$FIREBASE_APP_ID_RESOLVED"
            --release-notes "GitHub Actions | Branch: ${{ github.ref_name }} | Commit: ${{ github.sha }}"
            --token "$FIREBASE_TOKEN")

          [ -n "$FIREBASE_TESTER_GROUPS" ] && DIST_CMD+=(--groups "$FIREBASE_TESTER_GROUPS")
          [ -n "$FIREBASE_TESTERS" ]       && DIST_CMD+=(--testers "$FIREBASE_TESTERS")

          "${DIST_CMD[@]}"

  build_ios:
    name: Build iOS IPA
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm install

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Bundler and Ruby dependencies
        run: |
          gem install bundler
          bundle install

      - name: Cache Pods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install Pods
        run: npx pod-install ios

      - name: Build and Distribute iOS
        env:
          IOS_FIREBASE_APP_ID: ${{ secrets.IOS_FIREBASE_APP_ID }}
          FIREBASE_TESTER_GROUPS: ${{ secrets.FIREBASE_TESTER_GROUPS }}
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          # Code signing envs (placeholders for Match or Manual)
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          # If using Match, it should be called before gym in the Fastfile or here
          # For now, we assume certificates are accessible or Match is handled in Fastfile
          bundle exec fastlane ios distribute
        working-directory: ios

      - name: Upload IPA as artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-ios
          path: ios/build/ios/ipa/RNBoilerplate.ipa
          retention-days: 7
